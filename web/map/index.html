<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Paris â€” Dashboard immobilier par arrondissement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f5f5f7;
    }
    #map {
      position: absolute;
      inset: 0;
    }

    .panel {
      position: absolute;
      z-index: 2;
      top: 16px;
      left: 16px;
      background: #ffffff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0,0,0,.12);
      font-size: 13px;
      line-height: 1.5;
      max-width: 320px;
    }
    .panel h3 {
      margin: 0 0 6px;
      font-size: 15px;
    }
    .panel small {
      display: block;
      color: #666;
      margin-bottom: 6px;
    }

    .panel label {
      display: block;
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 2px;
      color: #555;
    }
    .panel select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
    }

    .legend {
      margin-top: 10px;
      font-size: 12px;
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .swatch {
      width: 18px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,.1);
    }

    .tooltip {
      position: absolute;
      z-index: 3;
      pointer-events: none;
      background: #111;
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 12px;
      transform: translate(-50%, -120%);
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      display: none;
      max-width: 280px;
      white-space: normal;
    }
    .tooltip strong {
      font-size: 13px;
    }
    .tooltip .metric {
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .tooltip .section-title {
      margin-top: 6px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .03em;
      opacity: .8;
    }
    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(255,255,255,0.12);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Paris â€“ Dashboard immobilier</h3>
    <small>Source : API FastAPI + CSV Gold agrÃ©gÃ©</small>

    <label for="metric-select">ðŸ“Š Indicateur cartographiÃ©</label>
    <select id="metric-select">
      <option value="prix_m2_median_2024" selected>Prix/mÂ² mÃ©dian (2024)</option>
      <option value="evolution_prix_m2_2020_2024_pct">Ã‰volution prix/mÂ² 2020â€“2024 (%)</option>
      <option value="part_logements_sociaux_apur_pct">% logements sociaux (APUR)</option>
      <option value="no2_moyen">NOâ‚‚ moyen (Âµg/mÂ³)</option>
      <option value="pm10_moyen">PM10 moyen (Âµg/mÂ³)</option>
      <option value="o3_moyen">Oâ‚ƒ moyen (Âµg/mÂ³)</option>
    </select>

    <div class="legend">
      <div><strong>LÃ©gende</strong></div>
      <div class="legend-row">
        <div class="swatch" id="swatch-1"></div> <span id="label-1">Faible</span>
      </div>
      <div class="legend-row">
        <div class="swatch" id="swatch-2"></div> <span id="label-2"></span>
      </div>
      <div class="legend-row">
        <div class="swatch" id="swatch-3"></div> <span id="label-3"></span>
      </div>
      <div class="legend-row">
        <div class="swatch" id="swatch-4"></div> <span id="label-4"></span>
      </div>
      <div class="legend-row">
        <div class="swatch" id="swatch-5"></div> <span id="label-5">Ã‰levÃ©e</span>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script>
    // ===========================
    // 1. CONFIG â€“ API & mÃ©triques
    // ===========================
    const API_BASE = '/api'; // adapte si ton API est sous un autre prefix (ex: '/gold/api')

    // statsByArr["1"] = { ... toutes les colonnes pour le 1er arr. ... }
    const statsByArr = {};
    const metricRanges = {};

    const METRICS_CONTINUES = [
      'prix_m2_median_2024',
      'evolution_prix_m2_2020_2024_pct',
      'part_logements_sociaux_apur_pct',
      'no2_moyen',
      'pm10_moyen',
      'o3_moyen'
    ];

    // ===========================
    // 2. Fonctions utilitaires
    // ===========================
    function buildMetricRanges() {
      for (const metric of METRICS_CONTINUES) {
        let values = [];
        for (const key in statsByArr) {
          const v = statsByArr[key][metric];
          if (v !== null && v !== undefined && !Number.isNaN(Number(v))) {
            values.push(Number(v));
          }
        }
        if (!values.length) {
          metricRanges[metric] = null;
          continue;
        }
        metricRanges[metric] = {
          min: Math.min(...values),
          max: Math.max(...values)
        };
      }
    }

    function colorForMetric(metric, value) {
      if (value == null || metricRanges[metric] == null) return '#eee';
      const v = Number(value);
      const { min, max } = metricRanges[metric];
      if (max === min) return '#2b8cbe';
      const ratio = (v - min) / (max - min);
      if (ratio <= 0.2) return '#f1eef6';
      if (ratio <= 0.4) return '#bdc9e1';
      if (ratio <= 0.6) return '#74a9cf';
      if (ratio <= 0.8) return '#2b8cbe';
      return '#045a8d';
    }

    function updateLegend(metric) {
      const range = metricRanges[metric];
      if (!range) {
        document.getElementById('label-1').textContent = 'Faible';
        document.getElementById('label-2').textContent = '';
        document.getElementById('label-3').textContent = '';
        document.getElementById('label-4').textContent = '';
        document.getElementById('label-5').textContent = 'Ã‰levÃ©e';
        return;
      }
      const { min, max } = range;
      const step = (max - min) / 5;

      function fmt(x) {
        if (metric.includes('prix_m2')) return Math.round(x).toLocaleString('fr-FR') + ' â‚¬/mÂ²';
        if (metric.includes('prix_median')) return Math.round(x).toLocaleString('fr-FR') + ' â‚¬';
        if (metric.includes('pct')) return x.toFixed(1).replace('.', ',') + ' %';
        if (metric.includes('no2') || metric.includes('pm10') || metric.includes('o3'))
          return x.toFixed(1).replace('.', ',');
        return x.toFixed(1);
      }

      document.getElementById('swatch-1').style.background = '#f1eef6';
      document.getElementById('swatch-2').style.background = '#bdc9e1';
      document.getElementById('swatch-3').style.background = '#74a9cf';
      document.getElementById('swatch-4').style.background = '#2b8cbe';
      document.getElementById('swatch-5').style.background = '#045a8d';

      document.getElementById('label-1').textContent = fmt(min) + ' ou moins';
      document.getElementById('label-2').textContent = fmt(min + step);
      document.getElementById('label-3').textContent = fmt(min + step * 2);
      document.getElementById('label-4').textContent = fmt(min + step * 3);
      document.getElementById('label-5').textContent = fmt(max) + ' ou plus';
    }

    function buildMatchExpression(metric, features) {
      const expr = ['match', ['to-string', ['get', 'numero']]];
      for (const f of features) {
        const numero = String(f.properties.numero);
        const stats = statsByArr[numero];
        const val = stats ? stats[metric] : null;
        expr.push(numero, colorForMetric(metric, val));
      }
      expr.push('#eee');
      return expr;
    }

    async function loadStatsFromAPI() {
      const res = await fetch(`${API_BASE}/arrondissements`);
      if (!res.ok) {
        console.error('Erreur API', res.status, await res.text());
        return;
      }
      const data = await res.json();

      for (const row of data) {
        // Accepte soit "arrondissement", soit "Arrondissement"
        const num = row.arrondissement ?? row.Arrondissement;
        if (!num) continue;
        statsByArr[String(num)] = row;
      }

      buildMetricRanges();
    }

    function formatNumber(n) {
      if (n == null) return 'N/A';
      return Number(n).toLocaleString('fr-FR');
    }

    function formatEuro(n) {
      if (n == null) return 'N/A';
      return Number(n).toLocaleString('fr-FR') + ' â‚¬';
    }

    function formatEuroM2(n) {
      if (n == null) return 'N/A';
      return Number(n).toLocaleString('fr-FR') + ' â‚¬/mÂ²';
    }

    function formatPct(n) {
      if (n == null) return 'N/A';
      return Number(n).toFixed(1).replace('.', ',') + ' %';
    }

    function buildTooltipContent(numero, stats) {
      if (!stats) {
        return `<strong>Paris ${numero}e</strong><br/>DonnÃ©es indisponibles`;
      }

      const prixM2 = stats.prix_m2_median_2024;
      const prixMed = stats.prix_median_2024;
      const evolM2 = stats.evolution_prix_m2_2020_2024_pct;
      const pctSoc = stats.part_logements_sociaux_apur_pct;
      const estSoc = stats.estimation_logement_social_pct;

      const nbStations = stats.nb_stations_metro;
      const traficMetro = stats.trafic_total_metro;
      const lignesMetro = stats.lignes_metro;
      const lignesRer = stats.lignes_rer;
      const no2 = stats.no2_moyen;
      const pm10 = stats.pm10_moyen;
      const o3 = stats.o3_moyen;
      const qa = stats.qualite_air_dominante;

      const pctT1 = stats.pct_T1_2024;
      const pctT2 = stats.pct_T2_2024;
      const pctT3 = stats.pct_T3_2024;
      const pctT4 = stats.pct_T4_2024;
      const pctT5 = stats.pct_T5plus_2024;

      const evolTxt = (evolM2 == null)
        ? 'N/A'
        : (evolM2 >= 0 ? '+' : '') + evolM2.toFixed(1).replace('.', ',') + ' %';

      return `
        <strong>Paris ${numero}e</strong>
        <div class="metric">
          <span class="status-pill">
            Prix/mÂ² 2024 : ${formatEuroM2(prixM2)}
          </span>
        </div>
        <div class="metric">
          Prix mÃ©dian 2024 : ${formatEuro(prixMed)}
        </div>
        <div class="metric">
          Ã‰volution prix/mÂ² 2020â€“2024 : ${evolTxt}
        </div>

        <div class="section-title">Logements sociaux</div>
        <div class="metric">
          Part APUR : ${pctSoc != null ? formatPct(pctSoc) : 'N/A'}
        </div>
        <div class="metric">
          Estimation : ${estSoc ?? 'N/A'}
        </div>

        <div class="section-title">Typologie (ventes 2024)</div>
        <div class="metric">
          T1 : ${pctT1 != null ? formatPct(pctT1) : 'N/A'} â€“ 
          T2 : ${pctT2 != null ? formatPct(pctT2) : 'N/A'}
        </div>
        <div class="metric">
          T3 : ${pctT3 != null ? formatPct(pctT3) : 'N/A'} â€“ 
          T4 : ${pctT4 != null ? formatPct(pctT4) : 'N/A'}
        </div>
        <div class="metric">
          T5+ : ${pctT5 != null ? formatPct(pctT5) : 'N/A'}
        </div>

        <div class="section-title">Transport</div>
        <div class="metric">
          Stations mÃ©tro : ${nbStations != null ? formatNumber(nbStations) : 'N/A'}
        </div>
        <div class="metric">
          Trafic annuel mÃ©tro : ${traficMetro != null ? formatNumber(traficMetro) : 'N/A'}
        </div>
        <div class="metric">
          MÃ©tro : ${lignesMetro || 'N/A'}
        </div>
        <div class="metric">
          RER : ${lignesRer || 'N/A'}
        </div>

        <div class="section-title">QualitÃ© de l'air</div>
        <div class="metric">
          NOâ‚‚ : ${no2 != null ? no2.toFixed(1).replace('.', ',') : 'N/A'} Âµg/mÂ³ â€“ 
          PM10 : ${pm10 != null ? pm10.toFixed(1).replace('.', ',') : 'N/A'} Âµg/mÂ³
        </div>
        <div class="metric">
          Oâ‚ƒ : ${o3 != null ? o3.toFixed(1).replace('.', ',') : 'N/A'} Âµg/mÂ³
        </div>
        <div class="metric">
          ApprÃ©ciation : ${qa || 'N/A'}
        </div>
      `;
    }

    // ===========================
    // 3. Carte MapLibre
    // ===========================
    const ARR_URL =
      "https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/arrondissements/exports/geojson?lang=fr&timezone=Europe%2FParis";

    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "osm-raster": {
            "type": "raster",
            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            "tileSize": 256,
            "attribution": "Â© OpenStreetMap contributors"
          }
        },
        "layers": [
          {
            "id": "osm-base",
            "type": "raster",
            "source": "osm-raster"
          }
        ]
      },
      center: [2.3522, 48.8566],
      zoom: 11.5
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');

    let geojsonArr = null;
    let hoverId = null;
    const tooltip = document.getElementById('tooltip');
    const metricSelect = document.getElementById('metric-select');

    map.on('load', async () => {
      // 1) Charger les stats depuis ton API FastAPI
      await loadStatsFromAPI();

      // 2) Charger le GeoJSON des arrondissements
      const res = await fetch(ARR_URL);
      geojsonArr = await res.json();

      // Normaliser : propriÃ©tÃ©s .numero + .nom_arr
      for (const f of geojsonArr.features) {
        const raw =
          f.properties.c_ar ||
          f.properties.numero ||
          f.properties.ar ||
          f.properties.num ||
          f.properties.CODE_ARR ||
          f.properties.CODE;
        f.properties.numero = String(raw).replace(/^0/, '');
        f.properties.nom_arr = f.properties.l_aroff || f.properties.nom || `Paris ${f.properties.numero}e`;
      }

      map.addSource('arr', {
        type: 'geojson',
        data: geojsonArr,
        promoteId: 'numero'
      });

      const metric = metricSelect.value;

      map.addLayer({
        id: 'arr-fill',
        type: 'fill',
        source: 'arr',
        paint: {
          'fill-color': buildMatchExpression(metric, geojsonArr.features),
          'fill-opacity': 0.65
        }
      });

      map.addLayer({
        id: 'arr-line',
        type: 'line',
        source: 'arr',
        paint: {
          'line-color': '#333',
          'line-width': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            2.2,
            1.0
          ]
        }
      });

      updateLegend(metric);

      // Interaction : hover + tooltip
      map.on('mousemove', 'arr-fill', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0];
        if (!f) return;

        if (hoverId !== f.id) {
          if (hoverId != null) {
            map.setFeatureState({ source: 'arr', id: hoverId }, { hover: false });
          }
          hoverId = f.id;
          map.setFeatureState({ source: 'arr', id: hoverId }, { hover: true });
        }

        const numero = String(f.properties.numero);
        const stats = statsByArr[numero];

        tooltip.style.left = e.point.x + 'px';
        tooltip.style.top = e.point.y + 'px';
        tooltip.style.display = 'block';
        tooltip.innerHTML = buildTooltipContent(numero, stats);
      });

      map.on('mouseleave', 'arr-fill', () => {
        map.getCanvas().style.cursor = '';
        tooltip.style.display = 'none';
        if (hoverId != null) {
          map.setFeatureState({ source: 'arr', id: hoverId }, { hover: false });
          hoverId = null;
        }
      });

      // On s'assure de bien cadrer Paris
      map.fitBounds([[2.224, 48.815], [2.469, 48.902]], { padding: 40 });

      // Changement de mÃ©trique
      metricSelect.addEventListener('change', () => {
        const metric = metricSelect.value;
        if (!geojsonArr) return;
        map.setPaintProperty(
          'arr-fill',
          'fill-color',
          buildMatchExpression(metric, geojsonArr.features)
        );
        updateLegend(metric);
      });
    });
  </script>
</body>
</html>
